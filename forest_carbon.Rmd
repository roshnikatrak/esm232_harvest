---
title: "forest_growth"
author: "Steven Cognac"
date: '2022-05-12'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(deSolve)
library(tidyverse)
library(sensitivity)
library(here)
```

## Background

Consider the following model of forest growth (where forest size is measured in units of carbon (C)):

$$dC/dt = r * C$$

for forest where **C is below a threshold canopy closure** and

$$dC/dt = g * (1 = C/K)$$

for forests where **carbon is at or above the threshold canopy closure**

and K is a carrying capacity in units of Carbon. The size of the forest (C), canopy closure threshold and carrying capacity are all in units of carbon. Think of the canopy closure threshold as the size of the forest at which growth rates change from exponential to linear. Think of _r_ as the early exponential growth rate and _g_ as the linear growth rate once canopy closure has been reached.

C = forest size, units of carbon
T = time, years
r = early exponential growth rate (before canopy closure has been reached)
g = the linear growth rate once canopy closure has been reached
K = carrying capacity, units of carbon

canopy closure threshold = the size of the forest at which growth rates change from exponential to linear

## Implement Model
```{r}
source(here("R/forest_growth.R"))
forest_growth
```

## Run model over 300 years using the ODE solver (`deSolve` package) starting with initial forest size of 10 kg carbon with the following parameters:

 - canopy_threshold = 50 kg (canopy closure threshold)
 - K = 250 kg C (carrying capacity)
 - r = 0.01 (exponential growth rate before canopy closure)
 - g = 2 kg/year (linear growth rate after canopy closure)

```{r initial_conditions}

years = seq(from = 1, to = 300)

Cinitial = 10

metrics = list(K=250, r=0.01, g=2, canopy_threshold=50)

carbon_growth = ode(y = Cinitial,
                    times = years, 
                    func = forest_growth, 
                    parms = metrics)

colnames(carbon_growth)=c("year","carbon")
```

```{r fig.width=7}
ggplot(as.data.frame(carbon_growth),aes(year, carbon))+
  geom_line(size = 2, linetype = "longdash") +
  labs(title = "Modeled Forest Size",
       subtitle = paste0("initial forest size = 10 kg carbon, r = 0.01 kg/year, g = 2 kg/year, \ncanopy threshold = 50 kg carbon, carrying capacity = 250 kg carbon"),
       x = "Years",
       y = "Forest Size (kg carbon)") +
  theme(title = element_text(size = 20))
```

## Run a Sobel sensitivity analysis and explore how the estimated max and mean forest size varies with the pre-canopy closure growth rate (*r*), post-canopy closure rate (*g*), canopy closure threshold, and carrying capacity (*K*).

Assumption is all parameters are normally distributed with a standard deviation of 10% of mean values.

```{r sobel_parameters}
# set number of parameters
n = 300

K = rnorm(mean=250, sd=25, n=n)
r = rnorm(mean=0.01, sd=0.001, n=n)
g = rnorm(mean=2, sd=0.2, n=n)
canopy_threshold = rnorm(mean=50, sd=0.1*50, n=n)

X1 = cbind.data.frame(r=r, K=K, g=g, canopy_threshold=canopy_threshold)

# repeat to get our second set of samples
K = rnorm(mean=250, sd=25, n=n)
r = rnorm(mean=0.01, sd=0.001, n=n)
g = rnorm(mean=2, sd=0.2, n=n)
canopy_threshold = rnorm(mean=50, sd=0.1*50, n=n)

X2 = cbind.data.frame(r=r, K=K, g=g, canopy_threshold=canopy_threshold)


# create our sobel object and get sets of parameters for running the model
sens_C = sobolSalt(model = NULL, X1,X2, nboot = 300)

# rename columns
colnames(sens_C$X) = c("r", "K", "g", "canopy_threshold")
head(sens_C$X)
```


## Create two functions to compute metrics. Then, run the ODE solver to compute metrics with wrapper function.

```{r}
# turn computing our metrics into a function
compute_metrics = function(result) {
  maxC = max(result$carbon)
  idx1 = which.max(result$carbon)
  maxyear = result$year[idx1]
  
  meanC = mean(result$carbon)
  
  
return(list(maxC=maxC,
            maxyear=maxyear, 
            meanC=meanC))}

# wrapper function
p_wrapper <- function(r, g, canopy_threshold, K, Cinitial, years, func) {
  
  parms <- list(r = r, g = g, canopy_threshold = canopy_threshold, K = K)
  result <- ode(y = Cinitial, 
                times = years,
                func = func,
                parms = parms,
                method = "lsode")
  colnames(result) <- c("year", "carbon")
  
  # get metrics
  metrics <- compute_metrics(as.data.frame(result))
  
  return(metrics)
  
}

```


```{r}
# now use pmap as we did before
allresults <- as.data.frame(sens_C$X) %>%
  pmap(p_wrapper, Cinitial=Cinitial, years=years, func=forest_growth)

# extract out results from pmap into a data frame
allres <-  allresults %>% 
  map_dfr(`[`,c("maxC","meanC"))
```


```{r plot_results}
# create boxplots
tmp <- allres %>% 
  pivot_longer(cols = 1:2,
               names_to = "metric",
               values_to = "value")


ggplot(tmp, aes(metric, value, col=metric)) +
  geom_boxplot()
```


Compute the sobol indicies for each metric

```{r sen3}
# sobol can only handle one output at a time  - so we will need to do them separately

sens_C_maxC = sensitivity::tell(sens_C, allres$maxC)

maxC_S <- sens_C_maxC$S %>% 
  rowid_to_column("parameters") %>% 
  ggplot() +
  geom_col(aes(x = original, y = parameters))
maxC_S

# plot(sens_C_maxC)

sens_C_meanC = sensitivity::tell(sens_C, allres$meanC)
# plot(sens_C_meanC)
```

